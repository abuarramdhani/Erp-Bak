<?php
Defined('BASEPATH') or exit('No Direct Script Access Allowed');

class M_chart extends CI_Model
{
    function __construct()
    {
				parent::__construct();
				$this->load->database();
        $this->oracle = $this->load->database('oracle',TRUE);
    }

		public function GetFinanceCostDashboard()
		{
				$sql = 
							"SELECT
							kca.GOLONGAN
							,sum(nvl(tbl1.total,0)) tahun_1
							,sum(nvl(tbl2.total,0)) tahun_2
							from
							(SELECT
							gcc.segment3 ACCOUNT
							,sum(
							NVL(gjl.ACCOUNTED_dr,0) -
							NVL(gjl.ACCOUNTED_cr,0) 
							) total
							FROM 
							gl_je_lines gjl
							,gl_code_combinations gcc
							,gl_je_headers gjh
							WHERE gjh.je_header_id = gjl.je_header_id
							and gcc.code_combination_id = gjl.code_combination_id
							and gjl.EFFECTIVE_DATE between '01-JAN-2018' AND add_months(last_day(sysdate),-12)
							AND ((gcc.segment4 BETWEEN '4000' AND '9ZZZ' OR (gcc.segment3 IN ('511101', '511102', '512101', '512102', '512103', '512104', '512105', '512106'
										, '512107', '512108', '512109', '512110', '512111', '512112', '512113', '512114', '512201', '513101', '513102'
										, '514101', '514102', '514103', '514104', '514105', '514106', '514107', '514108', '514109', '514110', '514111'
										, '514112', '514113', '514201', '515101', '515102', '515103', '515104', '515105', '515199', '515201', '515202'
										, '515203', '515204', '515401', '515402', '515403', '515404', '515499', '515501', '515502', '515503', '515505'
										, '515506', '515507', '515508', '515509', '515510', '515511', '515512', '515513', '515514', '515515', '515516'
										, '515517', '515518', '515519', '515520', '515521', '515522', '515523', '515524', '515525', '515526', '515527'
										, '515529', '515530', '515531', '515532', '515533', '515534', '515535', '515536', '515537', '515538', '515599'
										, '515601', '515602', '515603', '515604', '515605', '515606', '515607', '515608', '515609', '515610', '515301'
										, '515302', '515303', '515304', '515305', '515306', '515307', '515308', '522301', '522302', '522303'
										, '522304', '522305', '522306')AND gcc.segment4 = '0000'))
										AND gcc.segment3 not in ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																						,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																						,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																						,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																						,'521115','521201')
										AND gcc.segment3 NOT IN ('523202','523204','523203','523206','523102','523199','523207','523205','523101','523299'
																						,'523104','523106','523107','523201','515528','522522','522525','522526','524201','524205'
																						,'524204','524206','524202','523105','524104','523108','523103','522509','522505','522101'
																						,'515101','515103','515104','522104','522105','522103','515102','524101','524102','524103'
																						,'524105','524199')
										OR (gcc.segment3 IN ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																				,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																				,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																				,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																				,'521115','521201')
																				and (gcc.segment4='0000' OR gcc.segment4 between '4000' and '9ZZZ')
																				and (gcc.segment2='AC' OR gcc.segment2 between '00' and 'AA'))
										OR gcc.segment3 IN  ('515523','515524','515525','515520','522523','515535','515538','515301','515302','515303'
																				,'515304','515305','515306','515307','515308','515521','513101','513102','511102','511101'
																				,'515526','515536','515537','515599','515522','515604','515608','515504'))
							--and gcc.segment4 = NVL(:p_seksi, gcc.segment4)                                                                    
							group by gcc.segment3) tbl1
							,
							(SELECT
							gcc.segment3 ACCOUNT
							,sum(
							NVL(gjl.ACCOUNTED_dr,0) -
							NVL(gjl.ACCOUNTED_cr,0) 
							) total
							FROM 
							gl_je_lines gjl
							,gl_code_combinations gcc
							,gl_je_headers gjh
							WHERE gjh.je_header_id = gjl.je_header_id
							and gcc.code_combination_id = gjl.code_combination_id
							and gjl.EFFECTIVE_DATE between '01-JAN-2019' AND last_day(sysdate)
							AND ((gcc.segment4 BETWEEN '4000' AND '9ZZZ' OR (gcc.segment3 IN ('511101', '511102', '512101', '512102', '512103', '512104', '512105', '512106'
										, '512107', '512108', '512109', '512110', '512111', '512112', '512113', '512114', '512201', '513101', '513102'
										, '514101', '514102', '514103', '514104', '514105', '514106', '514107', '514108', '514109', '514110', '514111'
										, '514112', '514113', '514201', '515101', '515102', '515103', '515104', '515105', '515199', '515201', '515202'
										, '515203', '515204', '515401', '515402', '515403', '515404', '515499', '515501', '515502', '515503', '515505'
										, '515506', '515507', '515508', '515509', '515510', '515511', '515512', '515513', '515514', '515515', '515516'
										, '515517', '515518', '515519', '515520', '515521', '515522', '515523', '515524', '515525', '515526', '515527'
										, '515529', '515530', '515531', '515532', '515533', '515534', '515535', '515536', '515537', '515538', '515599'
										, '515601', '515602', '515603', '515604', '515605', '515606', '515607', '515608', '515609', '515610', '515301'
										, '515302', '515303', '515304', '515305', '515306', '515307', '515308', '522301', '522302', '522303'
										, '522304', '522305', '522306')AND gcc.segment4 = '0000'))
										AND gcc.segment3 not in ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																						,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																						,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																						,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																						,'521115','521201')
										AND gcc.segment3 NOT IN ('523202','523204','523203','523206','523102','523199','523207','523205','523101','523299'
																						,'523104','523106','523107','523201','515528','522522','522525','522526','524201','524205'
																						,'524204','524206','524202','523105','524104','523108','523103','522509','522505','522101'
																						,'515101','515103','515104','522104','522105','522103','515102','524101','524102','524103'
																						,'524105','524199')
										OR (gcc.segment3 IN ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																				,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																				,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																				,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																				,'521115','521201')
																				and (gcc.segment4='0000' OR gcc.segment4 between '4000' and '9ZZZ')
																				and (gcc.segment2='AC' OR gcc.segment2 between '00' and 'AA'))
										OR gcc.segment3 IN  ('515523','515524','515525','515520','522523','515535','515538','515301','515302','515303'
																				,'515304','515305','515306','515307','515308','515521','513101','513102','511102','511101'
																				,'515526','515536','515537','515599','515522','515604','515608','515504'))
							--and gcc.segment4 = NVL(:p_seksi, gcc.segment4)                                                                    
							group by gcc.segment3) tbl2
							,fnd_flex_values ffv
							,fnd_flex_values_tl ffvt
							,khs_costdown_account kca
							where 
							ffv.FLEX_VALUE = tbl1.account(+)
							and ffv.FLEX_VALUE = tbl2.account(+)
							and ffv.FLEX_VALUE_ID = ffvt.FLEX_VALUE_ID
							and ffv.FLEX_VALUE = kca.ACCOUNT 
							and (tbl1.total is not null or tbl2.total is not null) 
							group by
							kca.GOLONGAN
							order by 3 desc NULLS LAST";

				$query = $this->oracle->query($sql);
				return $query->result_array();
		}

		public function GetGroupList()
		{
				$sql = 
							"SELECT
									kca.SEQUENCE,
									kca.GOLONGAN
							from
									khs_costdown_account kca
							group by
									kca.SEQUENCE,
									kca.GOLONGAN
							order by 1";
							
				$query = $this->oracle->query($sql);
				return $query->result_array();
		}

		public function GetFinanceCostByGroupName($id)
		{
				$sql = 
							"SELECT
							tbl3.bulan
							,sum(nvl(tbl1.total,0)) tahun1
							,sum(nvl(tbl2.total,0)) tahun2
							from
							(SELECT
							kca.GOLONGAN
							,gjl.PERIOD_NAME
							,EXTRACT(month FROM gjl.EFFECTIVE_DATE) bulan
							,sum(
							NVL(gjl.ACCOUNTED_dr,0) -
							NVL(gjl.ACCOUNTED_cr,0) 
							) total
							FROM 
							gl_je_lines gjl
							,gl_code_combinations gcc
							,gl_je_headers gjh
							,khs_costdown_account kca
							WHERE gjh.je_header_id = gjl.je_header_id
							and gcc.code_combination_id(+) = gjl.code_combination_id
							and gjl.EFFECTIVE_DATE between '01-JAN-2018' AND add_months(last_day(sysdate),-12)
							AND ((gcc.segment4 BETWEEN '4000' AND '9ZZZ' OR (gcc.segment3 IN ('511101', '511102', '512101', '512102', '512103', '512104', '512105', '512106'
										, '512107', '512108', '512109', '512110', '512111', '512112', '512113', '512114', '512201', '513101', '513102'
										, '514101', '514102', '514103', '514104', '514105', '514106', '514107', '514108', '514109', '514110', '514111'
										, '514112', '514113', '514201', '515101', '515102', '515103', '515104', '515105', '515199', '515201', '515202'
										, '515203', '515204', '515401', '515402', '515403', '515404', '515499', '515501', '515502', '515503', '515505'
										, '515506', '515507', '515508', '515509', '515510', '515511', '515512', '515513', '515514', '515515', '515516'
										, '515517', '515518', '515519', '515520', '515521', '515522', '515523', '515524', '515525', '515526', '515527'
										, '515529', '515530', '515531', '515532', '515533', '515534', '515535', '515536', '515537', '515538', '515599'
										, '515601', '515602', '515603', '515604', '515605', '515606', '515607', '515608', '515609', '515610', '515301'
										, '515302', '515303', '515304', '515305', '515306', '515307', '515308', '522301', '522302', '522303'
										, '522304', '522305', '522306')AND gcc.segment4 = '0000'))
										AND gcc.segment3 not in ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																						,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																						,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																						,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																						,'521115','521201')
										AND gcc.segment3 NOT IN ('523202','523204','523203','523206','523102','523199','523207','523205','523101','523299'
																						,'523104','523106','523107','523201','515528','522522','522525','522526','524201','524205'
																						,'524204','524206','524202','523105','524104','523108','523103','522509','522505','522101'
																						,'515101','515103','515104','522104','522105','522103','515102','524101','524102','524103'
																						,'524105','524199')
										OR (gcc.segment3 IN ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																				,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																				,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																				,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																				,'521115','521201')
																				and (gcc.segment4='0000' OR gcc.segment4 between '4000' and '9ZZZ')
																				and (gcc.segment2='AC' OR gcc.segment2 between '00' and 'AA'))
										OR gcc.segment3 IN  ('515523','515524','515525','515520','522523','515535','515538','515301','515302','515303'
																				,'515304','515305','515306','515307','515308','515521','513101','513102','511102','511101'
																				,'515526','515536','515537','515599','515522','515604','515608','515504'))
							and gcc.segment3 = kca.ACCOUNT
							and kca.SEQUENCE = nvl($id, kca.SEQUENCE)
							--and gcc.segment4 = NVL(:p_seksi, gcc.segment4)                                                          
							group by kca.GOLONGAN,gjl.PERIOD_NAME,gjl.EFFECTIVE_DATE) tbl1
							,
							(SELECT
							kca.GOLONGAN 
							,gjl.PERIOD_NAME
							,EXTRACT(month FROM gjl.EFFECTIVE_DATE) bulan
							,sum(
							NVL(gjl.ACCOUNTED_dr,0) -
							NVL(gjl.ACCOUNTED_cr,0) 
							) total
							FROM 
							gl_je_lines gjl
							,gl_code_combinations gcc
							,gl_je_headers gjh
							,khs_costdown_account kca
							WHERE gjh.je_header_id = gjl.je_header_id
							and gcc.code_combination_id(+) = gjl.code_combination_id
							and gjl.EFFECTIVE_DATE between '01-JAN-2019' AND last_day(sysdate)
							AND ((gcc.segment4 BETWEEN '4000' AND '9ZZZ' OR (gcc.segment3 IN ('511101', '511102', '512101', '512102', '512103', '512104', '512105', '512106'
										, '512107', '512108', '512109', '512110', '512111', '512112', '512113', '512114', '512201', '513101', '513102'
										, '514101', '514102', '514103', '514104', '514105', '514106', '514107', '514108', '514109', '514110', '514111'
										, '514112', '514113', '514201', '515101', '515102', '515103', '515104', '515105', '515199', '515201', '515202'
										, '515203', '515204', '515401', '515402', '515403', '515404', '515499', '515501', '515502', '515503', '515505'
										, '515506', '515507', '515508', '515509', '515510', '515511', '515512', '515513', '515514', '515515', '515516'
										, '515517', '515518', '515519', '515520', '515521', '515522', '515523', '515524', '515525', '515526', '515527'
										, '515529', '515530', '515531', '515532', '515533', '515534', '515535', '515536', '515537', '515538', '515599'
										, '515601', '515602', '515603', '515604', '515605', '515606', '515607', '515608', '515609', '515610', '515301'
										, '515302', '515303', '515304', '515305', '515306', '515307', '515308', '522301', '522302', '522303'
										, '522304', '522305', '522306')AND gcc.segment4 = '0000'))
										AND gcc.segment3 not in ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																						,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																						,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																						,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																						,'521115','521201')
										AND gcc.segment3 NOT IN ('523202','523204','523203','523206','523102','523199','523207','523205','523101','523299'
																						,'523104','523106','523107','523201','515528','522522','522525','522526','524201','524205'
																						,'524204','524206','524202','523105','524104','523108','523103','522509','522505','522101'
																						,'515101','515103','515104','522104','522105','522103','515102','524101','524102','524103'
																						,'524105','524199')
										OR (gcc.segment3 IN ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																				,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																				,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																				,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																				,'521115','521201')
																				and (gcc.segment4='0000' OR gcc.segment4 between '4000' and '9ZZZ')
																				and (gcc.segment2='AC' OR gcc.segment2 between '00' and 'AA'))
										OR gcc.segment3 IN  ('515523','515524','515525','515520','522523','515535','515538','515301','515302','515303'
																				,'515304','515305','515306','515307','515308','515521','513101','513102','511102','511101'
																				,'515526','515536','515537','515599','515522','515604','515608','515504'))
							and gcc.segment3 = kca.ACCOUNT
							and kca.SEQUENCE = nvl($id, kca.SEQUENCE)
							--and gcc.segment4 = NVL(:p_seksi, gcc.segment4)                                                          
							group by kca.GOLONGAN,gjl.PERIOD_NAME,gjl.EFFECTIVE_DATE) tbl2
							,
							(select
							EXTRACT(month FROM gjl2.EFFECTIVE_DATE) bulan
							FROM 
							gl_je_lines gjl2
							,gl_code_combinations gcc2
							,gl_je_headers gjh2
							WHERE gjh2.je_header_id = gjl2.je_header_id
							and gcc2.code_combination_id = gjl2.code_combination_id
							and gjl2.EFFECTIVE_DATE between '01-JAN-2018' AND add_months(last_day(sysdate),-12)
							and gcc2.segment3 = '521101'
							group by gjl2.EFFECTIVE_DATE) tbl3
							where
							tbl3.bulan = tbl1.bulan(+)
							and tbl3.bulan = tbl2.bulan(+)
							group by tbl3.bulan
							order by 1";

				$query = $this->oracle->query($sql);
				return $query->result_array();
		}

		public function GetFinanceCostDetailByGroupName( $group , $sec=NULL )
		{
				$sql = 
							"SELECT
							to_number(REPLACE(nvl(gir.REFERENCE_9,'0'),',','.')) - to_number(REPLACE(nvl(gir.REFERENCE_10,'0'),',','.')) total 
							,gir.CREATION_DATE
							,case when gjh.je_category = 'Receiving' then (select rsl.item_description from rcv_transactions rct,rcv_shipment_lines rsl where rct.TRANSACTION_ID = xte.SOURCE_ID_INT_1 and rct.shipment_line_id = rsl.SHIPMENT_LINE_ID)
										else xal.DESCRIPTION 
							 end line_description
							FROM 
							gl_je_lines gjl
							,gl_code_combinations gcc
							,gl_je_headers gjh
							,khs_costdown_account kca
							,gl_import_references gir
							,xla_ae_lines xal
							,xla_ae_headers xah
							,xla_transaction_entities_upg xte
							WHERE gjh.je_header_id = gjl.je_header_id
							and gcc.code_combination_id(+) = gjl.code_combination_id
							and gjl.JE_HEADER_ID = gir.JE_HEADER_ID
							and gjl.JE_LINE_NUM = gir.JE_LINE_NUM
							and gir.gl_sl_link_id = xal.gl_sl_link_id
							and xal.AE_HEADER_ID = xah.AE_HEADER_ID
							and xte.application_id = xah.application_id
							and xte.entity_id = xah.entity_id
							and xte.ledger_id = xah.ledger_id
							and gjl.EFFECTIVE_DATE between '01-JAN-2019' AND last_day(sysdate)
							AND ((gcc.segment4 BETWEEN '4000' AND '9ZZZ' OR (gcc.segment3 IN ('511101', '511102', '512101', '512102', '512103', '512104', '512105', '512106'
										, '512107', '512108', '512109', '512110', '512111', '512112', '512113', '512114', '512201', '513101', '513102'
										, '514101', '514102', '514103', '514104', '514105', '514106', '514107', '514108', '514109', '514110', '514111'
										, '514112', '514113', '514201', '515101', '515102', '515103', '515104', '515105', '515199', '515201', '515202'
										, '515203', '515204', '515401', '515402', '515403', '515404', '515499', '515501', '515502', '515503', '515505'
										, '515506', '515507', '515508', '515509', '515510', '515511', '515512', '515513', '515514', '515515', '515516'
										, '515517', '515518', '515519', '515520', '515521', '515522', '515523', '515524', '515525', '515526', '515527'
										, '515529', '515530', '515531', '515532', '515533', '515534', '515535', '515536', '515537', '515538', '515599'
										, '515601', '515602', '515603', '515604', '515605', '515606', '515607', '515608', '515609', '515610', '515301'
										, '515302', '515303', '515304', '515305', '515306', '515307', '515308', '522301', '522302', '522303'
										, '522304', '522305', '522306')AND gcc.segment4 = '0000'))
										AND gcc.segment3 not in ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																						,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																						,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																						,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																						,'521115','521201')
										AND gcc.segment3 NOT IN ('523202','523204','523203','523206','523102','523199','523207','523205','523101','523299'
																						,'523104','523106','523107','523201','515528','522522','522525','522526','524201','524205'
																						,'524204','524206','524202','523105','524104','523108','523103','522509','522505','522101'
																						,'515101','515103','515104','522104','522105','522103','515102','524101','524102','524103'
																						,'524105','524199')
										OR (gcc.segment3 IN ('512101','512102','512103','512104','512105','512106','512108','512109','512110','512111'
																				,'512112','512113','512114','512201','514101','514102','514103','514104','514105','514106'
																				,'514108','514109','514110','514111','514112','514113','514201','521101','521102','521103'
																				,'521104','521105','521106','521108','521109','521110','521111','521112','521113','521114'
																				,'521115','521201')
																				and (gcc.segment4='0000' OR gcc.segment4 between '4000' and '9ZZZ')
																				and (gcc.segment2='AC' OR gcc.segment2 between '00' and 'AA'))
										OR gcc.segment3 IN  ('515523','515524','515525','515520','522523','515535','515538','515301','515302','515303'
																				,'515304','515305','515306','515307','515308','515521','513101','513102','511102','511101'
																				,'515526','515536','515537','515599','515522','515604','515608','515504'))
							and gcc.segment3 = kca.ACCOUNT
							and kca.SEQUENCE = $group
							and gcc.segment4 = NVL('$sec', gcc.segment4)  
							and (gir.REFERENCE_9 is not null or gir.REFERENCE_10 is not null)                                                      
							order by 3";
							
				$query = $this->oracle->query($sql);
				return $query->result_array();
		}

}
?>